version: 2
jobs:
  build:
    docker:
      - image: docker:1.13.1
    working_directory: ~/app
    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Build image
          command: |
            docker build --rm=false -t loffek/serviceb .

      - run:
          name: Test
          command: |
            docker run loffek/serviceb ./test.sh

      - deploy:
          name: Publish to DockerHub
          command: |
            docker login -u $DOCKER_HUB_USER_ID -p $DOCKER_HUB_PWD
            docker tag loffek/serviceb $DOCKER_HUB_USER_ID/serviceb:$CIRCLE_SHA1
            docker push $DOCKER_HUB_USER_ID/serviceb:$CIRCLE_SHA1

      - deploy:
          name: Integration test
          command: |
            curl -u ${PERSONAL_API_TOKEN}: \
                 -d build_parameters[CIRCLE_JOB]=build \
                 -d build_parameters[SERVICE_B_TAG]=$CIRCLE_SHA1 \
                 https://circleci.com/api/v1.1/project/github/$CIRCLE_PROJECT_USERNAME/servicecomposer/tree/master

      # Poll for success
      # Fail or succeed the test

      # Only if branch is master, publish with tag "latest"
